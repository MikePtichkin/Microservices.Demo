## Report service

Cервис для демонстрации навыков работы с CancellationTokenSource, асинхронностью и многопоточностью на примере SemaphoreSlim.

Проблема:
Некоторые покупатели хотят иметь возможность выгружать историю заказов в формате [CSV](https://ru.wikipedia.org/wiki/CSV).

> Допущение. Так как в `Order Service` нет возможности фильтровать по датам, то и отчет мы будем запрашивать сразу за все время.

### Описание сервиса

1. REST метод, который принимаtn id покупателя (customer_id) и возвращать отчет в формате [CSV](https://ru.wikipedia.org/wiki/CSV).
2. Данные о заказах запрашиваются из `Order Service`.
3. В сервисе реализована систему **RateLimit**, которая ограничит количество одновременно обрабатываемых запросов до **N** штук.
**N** определяется в `appsetting.json`. **N** по умолчанию равно *2*. Если количество одновременных запросов превышает **N**, то мы просто держим соединение, пока не сможем обработать.
> ASP NET имеет уже готовую реализицию [RateLimit](https://learn.microsoft.com/en-us/aspnet/core/performance/rate-limit). Для демонстрационных целей сделана простая реализация RateLimit, которая просто ограничивает уровень параллельной обработки.
4. Единовременно по одному покупателю (customer) может формироваться только 1 отчет. Если в момент формирования отчета поступает новый запрос, то сервис завершает формирование старого отчета и начать новое формирование. 
    > Например: Пользователь запросил отчет через браузер на вкладке 1. Пока отчет формировался, пользователь уже из вкладки 2 запросил еще один отчет. 
    Сервис завершает формирование отчета, который был запущен из вкладки 1, вернув ошибку. Формирование отчета для вкладки 2 продолжиться.
    Это реализовано путем сохранения в ConcurrentDictionary CancellationTokenSource по ключу (customer_id) для формирующегося отчета.
    Из другого потока можно обратиться в ConcurrentDictionary с CTS для запроса отмены генерации отчета которая идет в другом потоке/запросе.

5. Если клиент обрывает соединение, то прекращается формирование отчета, так как никто уже не ждет ответа.

Формат CSV

|Id заказа|Статус|Коммент|Дата создания|
|---------|------|-------|-------------|
|long     |text  |text   |datetime     | 

## PS
Запрос в `Order Service` разбит на батчи для распараллеливания запроса. Ограничено количество одновременных подключений до 20.

Для формирования CSV используется [CsvHelper](https://joshclose.github.io/CsvHelper)